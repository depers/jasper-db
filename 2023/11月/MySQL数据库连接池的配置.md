> 数据库/HikariCP/Java

> 之前对数据库连接池的知识了解比较少，在日常的开发工作中也没有主导过这块的知识点，准备写一篇文章，梳理一下。

# MySQL连接池的配置

## 配置MySQL的最大连接数

最大连接数：根据你的应用程序需求，你可能需要增加最大连接数以处理并发请求。你可以通过修改MySQL配置文件中的max_connections来增加最大连接数。

* 查询数据库中配置的最大连接数：`show variables linke 'max_connections'`

* 修改数据库中的最大连接数

    * 第一种方法：在数据库权限满足的情况下，执行`set global max_connections = 200;`。这个设置会马上生效，但是当mysql重启时这个设置会失效，所以建议使用方法二。

    * 第二种方法：更好的办法是修改mysql的ini配置文件*my.ini*，linux为*my.cnf*。

        找到mysqld块，修改或者添加下面的设置，重启MySQL：

        ```
        max_connections=200
        ```

# 为什么需要数据库连接池

一个数据库连接对象均对应一个物理数据库连接，每次操作都打开一个物理连接，使用完都关闭连接，这样造成系统的 性能低下。

通过观察访问MySQL的TCP请求发现，执行SQL所占用的时间很短，但是建立连接和关闭连接的操作花费了大部分的时间。

数据库连接池最重要的两个配置

数据库连接池有两个最重要的配置： **最小连接数**和**最大连接数**， 它们控制着从连接池中获取连接的流程：

* 如果**当前连接数小于最小连接数**，则创建新的连接处理数据库请求；

    假设我们科目二练车，驾校一共有10台教练车（最大连接数），正常情况下训练场上会停4辆车（最小连接数），车库放6辆。新来一个学员，发现训练场上有停着的教练车（小于最小连接数），就直接让他上没有被使用的教练车。

* 如果连接池中**有空闲连接**则复用空闲连接；

    当新来的学员人数大于训练场上的车辆数时，看训练场上有没有空闲的车辆，如果有的话，让他直接上车。

* 如果**空闲池中没有连接**并且**当前连接数小于最大连接数**，则创建新的连接处理请求；

    有新学员来了，如果训练场上没有空闲的车辆，如果没有且训练场上的车辆数量小于10辆，则去车库开新的教练车。

* 如果**当前连接数已经大于等于最大连接数**，则按照配置中**设定的时间**（C3P0 的连接池配置是 checkoutTimeout）等待旧的连接可用；

    有新学员来了，如果训练场上的学员人数大于10台，则让新来学员去大厅等候，等待练车，假设新学员有事只等5分钟。

* 如果**等待超过了这个设定时间**则向用户抛出错误。

    新来学员发现他等了五分钟，还是没有空闲车辆，所以你要告诉学员让他改天再来练车。

# HikariCP

## HikariCP的常用配置

关于常用配置的解释可以直接去项目的github主页查看，我这边就基础配置，简述下自己的理解。

*  【必须设置】jdbcUrl：jdbc的连接地址
*  【必须设置】username：数据库用户名
*  【必须设置】password：数据库密码
*  autoCommit：连接池的连接是否支持自动提交，默认为true。
*  connectionTimeout：客户端等待连接池返回连接的最大毫秒数。如果超过此时间而连接不可用，则将引发 SQLException。可接受的最低连接超时为 250 毫秒。默认值：30000（30 秒）。
*  idleTimeout：
    * 连接在池中允许闲置的最大时间。
    * 此设置仅在minimumIdle被定义为小于maximumPoolSize时适用。
    * 在超时之前，连接永远不会被停用。
    * 值为0表示永远不会从池中删除空闲连接。最小允许值为10000ms(10秒)。默认值：600000(10分钟)。
    * HikariCP专门设置了一个定时任务housekeeping task去清理空闲连接和保持空闲连接的最小连接数。空闲连接是否停用，时间上存在的误差大概平均在15s左右，最大误差是30s，因为这个定时任务时每30s执行一次。
    * 这块属性的具体使用待后续出一篇文章单独来讨论。
*  keppaliveTime
    * 该属性控制HikariCP尝试保持连接活动的频率，以防止数据库或网络基础设施超时。
    * 该值必须小于maxLifetime值。
    * “keepalive“只会发生在空闲连接上。当到达对给定连接进行“keepalive”的时间时，将从池中删除该连接，对其进行“ping”，然后返回到池中。ping是调用JDBC4的isValid()方法，或者执行connectionTestQuery。
    * 通常，池外的持续时间应该以个位数毫秒甚至亚毫秒为单位进行测量，因此应该很少或没有明显的性能影响。
    * 允许的最小值是30000ms(30秒)，但最理想的值是分钟。默认值：0(禁用)。
    * 这块属性的具体使用待后续出一篇文章单独来讨论。
*  【必须设置】maxLifetime
    * 此属性控制池中连接的最大生存期。
    * 一个正在使用的连接永远不会退役，只有当它被关闭时才会被移除。
    * 在逐个连接的基础上，采用轻微的负衰减以避免池中的大规模消光。
    * 我们强烈建议设置这个值，它应该比任何数据库或基础设施强加的连接时间限制短几秒。值为0表示没有最大生存期(无限生存期)，当然取决于idleTimeout设置。
    * 最小允许值为30000ms(30秒)，默认值：1800000(30分钟)。
    * 这块属性的具体使用待后续出一篇文章单独来讨论。
*  connectionTestQuery
    * 如果您的驱动程序支持 JDBC4，我们强烈建议**不要设置此属性**。
    * 这适用于不支持 JDBC4 的“传统”驱动程序 `Connection.isValid()`API 。这是在从池中向您提供连接之前将执行的查询，以验证与数据库的连接是否仍处于活动状态。同样，尝试在没有此属性的情况下运行池，如果您的驱动程序不符合 JDBC4，HikariCP 将记录错误以通知您。
    * 默认值：无
*  minimumIdle
    * 此属性控制 HikariCP 尝试在池中维护的最小空闲连接数。
    * 如果空闲连接数低于此值，并且池中的总连接数小于 maximumPoolSize ，HikariCP 将尽最大努力快速有效地添加其他连接。但是，为了获得最佳性能和对峰值需求的响应能力，我们建议**不要设置此值**，而是允许 HikariCP 充当固定大小的连接池。
    * 默认值：与 maximumPoolSize 相同
*  【必须设置】maximumPoolSize
    * 此属性控制允许池达到的最大大小，包括空闲和正在使用的连接。
    * 基本上，此值将确定与数据库后端的最大实际连接数。此值的设置最好由执行环境确定。
    * 当池中连接的数量达到此大小，并且没有空闲连接可用时，对 `getConnection()` 的调用将阻塞长达`connectionTimeout`几毫秒，然后超时。请阅读有关泳池大小的信息。
    * 默认值：10。
*  metricRegistry
    *  此属性只能通过编程配置或 IoC 容器使用。此属性允许您指定池 `MetricRegistry` 用于记录数据源的各种指标。
    *  关于这个属性的配置和解释，待后续出一篇文章来做讨论。
*  healthCheckRegistry
    *  此属性只能通过编程配置或 IoC 容器使用。此属性允许您指定池`HealthCheckRegistry`用于报告当前运行状况。
    *  关于这个属性的配置和解释，待后续出一篇文章来做讨论。
*  poolName
    * 此属性表示连接池的用户定义名称，主要显示在日志记录和 JMX 管理控制台中，以标识池和池配置。默认值：自动生成。

# 参考文章

* [07丨池化技术：如何减少频繁创建数据库连接的性能损耗？](https://zq99299.github.io/note-architect/hc/02/01.html#%E7%94%A8%E8%BF%9E%E6%8E%A5%E6%B1%A0%E9%A2%84%E5%85%88%E5%BB%BA%E7%AB%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5)
* [Github-HikariCP](https://github.com/brettwooldridge/HikariCP)