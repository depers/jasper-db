> 数据库

> 之前对数据库连接池的知识了解比较少，在日常的开发工作中也没有主导过这块的知识点，准备写一篇文章，梳理一下。

# 配置MySQL的最大连接数

最大连接数：根据你的应用程序需求，你可能需要增加最大连接数以处理并发请求。你可以通过修改MySQL配置文件中的max_connections来增加最大连接数。

* 查询数据库中配置的最大连接数：`show variables linke 'max_connections'`

* 修改数据库中的最大连接数

  * 第一种方法：在数据库权限满足的情况下，执行`set global max_connections = 200;`。这个设置会马上生效，但是当mysql重启时这个设置会失效，所以建议使用方法二。

  * 第二种方法：更好的办法是修改mysql的ini配置文件my.ini，linux为my.cnf。

    找到mysqld块，修改或者添加下面的设置，重启MySQL：

    ```
    max_connections=200
    ```

# 为什么需要数据库连接池

一个数据库连接对象均对应一个物理数据库连接，每次操作都打开一个物理连接，使用完都关闭连接，这样造成系统的 性能低下。

通过观察访问MySQL的TCP请求发现，执行SQL所占用的时间很短，但是建立连接和关闭连接的动作花费了大部分的时间。

# 数据库连接池最重要的两个配置

数据库连接池有两个最重要的配置： **最小连接数**和**最大连接数**， 它们控制着从连接池中获取连接的流程：

* 如果**当前连接数小于最小连接数**，则创建新的连接处理数据库请求；

  假设我们科目二练车，驾校一共有10台教练车（最大连接数），正常情况下训练场上会停4辆车（最小连接数），车库放6辆。新来一个学员，发现训练场上有停着的教练车（小于最小连接数），就直接让他上没有被使用的教练车。

* 如果连接池中**有空闲连接**则复用空闲连接；

  当新来的学员人数大于训练场上的车辆数时，看训练场上有没有空闲的车辆，如果有的话，让他直接上车。

* 如果**空闲池中没有连接**并且**当前连接数小于最大连接数**，则创建新的连接处理请求；

  有新学员来了，如果训练场上没有空闲的车辆，如果没有且训练场上的车辆数量小于10辆，则去车库开新的教练车。

* 如果**当前连接数已经大于等于最大连接数**，则按照配置中**设定的时间**（C3P0 的连接池配置是 checkoutTimeout）等待旧的连接可用；

  有新学员来了，如果训练场上的学员人数大于10台，则让新来学员去大厅等候，等待练车，假设新学员有事只等5分钟。

* 如果**等待超过了这个设定时间**则向用户抛出错误。

  新来学员发现他等了五分钟，还是没有空闲车辆，所以你要告诉学员让他改天再来练车。

未完待续~