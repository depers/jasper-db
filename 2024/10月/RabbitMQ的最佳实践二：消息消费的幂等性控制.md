| title                                      | tags                     | background                                                   | auther | isSlow |
| ------------------------------------------ | ------------------------ | ------------------------------------------------------------ | ------ | ------ |
| RabbitMQ的最佳实践二：消息消费的幂等性控制 | 消息队列/RabbitMQ/Spring | 最近在项目开发中用到了RabbitMQ，其中涉及到的知识点还是比较多的，想通过这篇文章对RabbitMQ开发中涉及到的点进行一个梳理，方便后续工作中借鉴和扩展。这篇文章是这一系列的第二篇文章，我们来讨论消息消费端的幂等性控制。 | depers | true   |

# 概念明确

在这里我讲三个概念，分别是**幂等性**、**防重放**和**防重复点击**。这三个概念都和**重复**有着有着一定的关系。

## 幂等性

### 1. 概念解释

首先我们来看幂等性控制，这里我们一般指的是Web服务中的接口幂等性，在HTTP/1.1中，对幂等性进行了定义。它描述了一次和多次请求某一个资源对于资源本身应该具有同样的结果（网络超时等问题除外），即第一次请求的时候对资源产生了副作用，但是以后的多次请求都不会再对资源产生副作用。

用人话来说就是有一个扣减库存的接口，会将商品的库存减一，如果订单A第一次请求扣减库存后，后面接着多次请求都不再扣减库存了，因为一个订单只会扣减一次库存。如果在这里我们不做幂等性控制，就可能会造成库存被多次扣减的情况。

值得注意的是幂等性和并发控制是两个概念，千万不要混淆。

### 2. 在Web开发中出现幂等性问题的场景

- **前端重复提交表单**： 在填写一些表格时候，用户填写完成提交，很多时候会因网络波动没有及时对用户做出提交成功响应，致使用户认为没有成功提交，然后一直点提交按钮，这时就会发生重复提交表单请求。
- **用户恶意进行刷单**： 例如在实现用户投票这种功能时，如果用户针对一个用户进行重复提交投票，这样会导致接口接收到用户重复提交的投票信息，这样会使投票结果与事实严重不符。
- **接口超时重复提交**：很多时候 HTTP 客户端工具都默认开启超时重试的机制，尤其是第三方调用接口时候，为了防止网络波动超时等造成的请求失败，都会添加重试机制，导致一个请求提交多次。
- **消息进行重复消费**： 当使用 MQ 消息中间件时候，如果发生消息中间件出现错误未及时提交消费信息，导致发生重复消费。

### 3. RestFul API中接口的幂等性

在Restful 推荐的几种 HTTP 接口方法中，分别存在幂等行与不能保证幂等的方法，如下：

| http方法 | 是否幂等         | 解释                                                         |
| :------- | :--------------- | :----------------------------------------------------------- |
| GET      | 是               | GET方法一般用来执行查询操作，不会对系统资源进行变更，所以是天然幂等的。 |
| POST     | 否               | PSOT操作一般用于执行新增操作，所以多次执行就会新增多条数据，不是幂等的。 |
| PUT      | 需要根据场景区分 | PUT操作一般用于修改操作，修改一般分为更新某个特定字段或是对某个字段进行累加，前者多次执行是幂等的，后者则每次修改后的结果都不同，所以不是幂等的。 |
| DELETE   | 需要根据场景区分 | DELETE操作一般用于删除操作，删除一般分为按唯一主键删除或是按条件删除，前者多次执行删除操作是幂等的，后者如果第一次删除后，有新增了一批数据，再次删除就会导致误删数据，所以不是幂等的。 |

### 4. 数据库操作的幂等性

在执行数据库操作时，与RestFul API一样不同的操作在幂等性方面也有着不同的表现，如下：

| 数据库操作 | 是否幂等         | 解释                                                         |
| ---------- | ---------------- | ------------------------------------------------------------ |
| SELECT     | 是               | 不会对业务数据有影响，天然幂等。和RestFul API的GET方法一样。 |
| INSERT     | 否               | 多次执行不能保证幂等性。和RestFul API的POST方法一样。        |
| UPDATE     | 需要根据场景区分 | 和RestFul API的PUT方法一样。                                 |
| DELETE     | 需要根据场景区分 | 和RestFul API的DELETE方法一样。                              |

### 5. 解决幂等性问题的方法

1. 方法一：数据库唯一主键如何实现幂等性

    1. 解释

        数据库唯一主键的实现主要是利用数据库中主键唯一约束的特性，一般来说唯一主键比较适用于“**插入**””时的幂等性，其能保证一张表中只能存在一条带该唯一主键的记录。

    2. 适用场景

# RabbitMQ中消息消费的幂等性控制

# 参考文章

- [简单聊一聊幂等和防重](https://juejin.cn/post/7302805039450292233?searchId=2024100816365224874698A0E01F636BF2)
- [一口气说出四种幂等性解决方案，面试官露出了姨母笑~](https://juejin.cn/post/6906290538761158670?searchId=2024100816365224874698A0E01F636BF2)
- [如何保证 RabbitMQ 的消息可靠性](https://juejin.cn/post/7228864364744507450?searchId=2024100816365224874698A0E01F636BF2)
- [RabbitMQ 可靠性、重复消费、顺序性、消息积压解决方案](https://juejin.cn/post/6977981645475282958?searchId=2024100816365224874698A0E01F636BF2)